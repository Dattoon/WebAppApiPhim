@model HomeViewModel
@{
    ViewData["Title"] = "Trang chủ";
}

<div class="container">
    <div class="section-title">
        <h2>Phim mới cập nhật</h2>
    </div>

    <div class="movie-grid">
        @foreach (var movie in Model.LatestMovies)
        {
            <div class="movie-card">
                <a asp-controller="Movie" asp-action="Detail" asp-route-slug="@movie.Slug">
                    <img src="@(movie.PosterUrl ?? movie.ThumbUrl ?? "/placeholder.svg?height=450&width=300")"
                         alt="@movie.Name"
                         onerror="this.onerror=null; this.src='/placeholder.svg?height=450&width=300';">
                    <div class="overlay">
                        <div class="title">@movie.Name</div>
                        <div class="info">
                            @movie.Year • @movie.Loai_phim
                        </div>
                    </div>
                </a>
            </div>
        }
    </div>

    @if (Model.Pagination != null && Model.Pagination.Total_pages > 1)
    {
        <div class="pagination-container">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    @if (Model.Pagination.Current_page > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" asp-controller="Home" asp-action="Index" asp-route-page="1" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" asp-controller="Home" asp-action="Index" asp-route-page="@(Model.Pagination.Current_page - 1)" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    }

                    @{
                        int startPage = Math.Max(1, Model.Pagination.Current_page - 2);
                        int endPage = Math.Min(Model.Pagination.Total_pages, startPage + 4);

                        if (endPage - startPage < 4)
                        {
                            startPage = Math.Max(1, endPage - 4);
                        }
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == Model.Pagination.Current_page ? "active" : "")">
                            <a class="page-link" asp-controller="Home" asp-action="Index" asp-route-page="@i">@i</a>
                        </li>
                    }

                    @if (Model.Pagination.Current_page < Model.Pagination.Total_pages)
                    {
                        <li class="page-item">
                            <a class="page-link" asp-controller="Home" asp-action="Index" asp-route-page="@(Model.Pagination.Current_page + 1)" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" asp-controller="Home" asp-action="Index" asp-route-page="@Model.Pagination.Total_pages" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    }

    <!-- Nút tải thêm phim -->
    <div class="text-center mt-4 mb-5">
        <button id="loadMoreBtn" class="btn btn-primary" data-current-page="@Model.Pagination.Current_page" data-total-pages="@Model.Pagination.Total_pages">
            <i class="fas fa-sync-alt me-2"></i> Tải thêm phim
        </button>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Xử lý nút tải thêm phim
            $("#loadMoreBtn").on("click", function () {
                var button = $(this);
                var currentPage = parseInt(button.data("current-page"));
                var totalPages = parseInt(button.data("total-pages"));

                if (currentPage < totalPages) {
                    var nextPage = currentPage + 1;
                    button.html('<i class="fas fa-spinner fa-spin me-2"></i> Đang tải...');
                    button.prop("disabled", true);

                    $.ajax({
                        url: '@Url.Action("LoadMoreMovies", "Home")',
                        type: 'GET',
                        data: { page: nextPage },
                        success: function (data) {
                            // Thêm phim vào grid
                            $(".movie-grid").append(data);

                            // Cập nhật trạng thái nút
                            button.data("current-page", nextPage);
                            button.html('<i class="fas fa-sync-alt me-2"></i> Tải thêm phim');
                            button.prop("disabled", false);

                            // Ẩn nút nếu đã tải hết trang
                            if (nextPage >= totalPages) {
                                button.hide();
                            }
                        },
                        error: function () {
                            button.html('<i class="fas fa-exclamation-circle me-2"></i> Lỗi! Thử lại');
                            button.prop("disabled", false);
                        }
                    });
                }
            });
        });
    </script>
}
